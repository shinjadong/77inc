# ë²•ì¸ì¹´ë“œ ìë™ë¶„ë¥˜ ì‹œìŠ¤í…œ ê°œì„  ê³„íšì„œ

ì‘ì„±ì¼: 2025-10-22
ë²„ì „: 2.0

---

## 1. í˜„í™© ë¶„ì„

### 1.1 í˜„ì¬ ì‹œìŠ¤í…œ êµ¬ì¡°

```
[í˜„ì¬ ì•„í‚¤í…ì²˜]
ì¹´ë“œ ëª…ì„¸ì„œ (XLSX)
    â†“
ì „ì²˜ë¦¬ â†’ ë£©ì—…(CSV) â†’ Fuzzy â†’ Claude API â†’ ê·œì¹™
    â†“
ë¶„ë¥˜ ê²°ê³¼ (CSV)
    â†“
AI ìµœì¢… ê²€í† 
    â†“
ë²•ì¸ì¹´ë“œ_(ì›”)ì›”_(ì¹´ë“œ).csv/xlsx
    (ê²€í† ì˜ê²¬ ì»¬ëŸ¼ í¬í•¨) âš ï¸
```

### 1.2 í•µì‹¬ ë¬¸ì œì 

#### ë¬¸ì œ 1: ìµœì¢… ê²°ê³¼ë¬¼ì— AI í”ì  ë…¸ì¶œ ğŸ”´
```csv
ê²°ì œì¼ì,ê°€ë§¹ì ëª…,ì´ìš©ê¸ˆì•¡,ì‚¬ìš©ìš©ë„,ì‹ ë¢°ë„,í™•ì •ë°©ë²•,ê²€í† ì˜ê²¬
2025-08-23,ì™€ì™€ì‹ë‹¹,0,ì¤‘ì‹ëŒ€,0.95,ìˆ˜ë™ê²€í† í•„ìš”,"AI ì½”ë©˜íŠ¸..."
```

**ë¬¸ì œ**:
- `ì‹ ë¢°ë„`, `í™•ì •ë°©ë²•`, `ê²€í† ì˜ê²¬` ì»¬ëŸ¼ì´ AI ì‚¬ìš© ë…¸ì¶œ
- ì‚¬ëŒì´ ìˆ˜ì‘ì—…í•œ ê²ƒì²˜ëŸ¼ ë³´ì—¬ì•¼ í•¨
- ë¶€ê°€ì„¸ ì‹ ê³  ì‹œ AI ì‚¬ìš© ê°ì§€ ê°€ëŠ¥

**ìš”êµ¬ì‚¬í•­**:
```csv
ê²°ì œì¼ì,ê°€ë§¹ì ëª…,ì´ìš©ê¸ˆì•¡,ì‚¬ìš©ìš©ë„
2025-08-23,ì™€ì™€ì‹ë‹¹,0,ì¤‘ì‹ëŒ€
```
â†’ ê¹”ë”í•œ 4ì»¬ëŸ¼ë§Œ ì¶œë ¥

#### ë¬¸ì œ 2: CSV ê¸°ë°˜ ì •ë‹µ DBì˜ í•œê³„ ğŸŸ¡
```
í˜„ì¬: data/master_db.csv (104ê±´)
    - ì •í™• ì¼ì¹˜ë§Œ ê°€ëŠ¥
    - ì˜ë¯¸ì  ìœ ì‚¬ë„ ê³„ì‚° ë¶ˆê°€
    - ê²€ìƒ‰ ì„±ëŠ¥ ì œí•œ
```

**í•œê³„**:
- "GSì¹¼í…ìŠ¤ ì•ˆì‚°ì " vs "GSì¹¼í…ìŠ¤ ì¸ì²œê³µí•­ì " êµ¬ë¶„ ì–´ë ¤ì›€
- ë²¡í„° ì„ë² ë”© ì—†ì–´ ì˜ë¯¸ë¡ ì  ë§¤ì¹­ ë¶ˆê°€
- ëŒ€ê·œëª¨ í™•ì¥ ì‹œ ì„±ëŠ¥ ì €í•˜

#### ë¬¸ì œ 3: MCP í†µí•© ë¶€ì¬ ğŸŸ¡
```
í˜„ì¬: ë…ë¦½ ì‹¤í–‰í˜• Python ìŠ¤í¬ë¦½íŠ¸
    - ë‹¤ë¥¸ ë„êµ¬ì™€ ì—°ë™ ì–´ë ¤ì›€
    - ì›Œí¬í”Œë¡œìš° ìë™í™” ì œí•œ
```

---

## 2. ê°œì„  ë°©ì•ˆ ë¹„êµ ë¶„ì„

### ë°©ì•ˆ A: PostgreSQL + pgvector (ê³ ê¸‰)

#### ì•„í‚¤í…ì²˜
```
PostgreSQL DB
â”œâ”€â”€ merchants í…Œì´ë¸”
â”‚   â”œâ”€â”€ id (PK)
â”‚   â”œâ”€â”€ name (ê°€ë§¹ì ëª…)
â”‚   â”œâ”€â”€ category (ì‚¬ìš©ìš©ë„)
â”‚   â”œâ”€â”€ embedding (vector) â† pgvector
â”‚   â””â”€â”€ confidence (ì‹ ë¢°ë„)
â”‚
â””â”€â”€ transactions í…Œì´ë¸”
    â”œâ”€â”€ id (PK)
    â”œâ”€â”€ merchant_id (FK)
    â”œâ”€â”€ date (ê²°ì œì¼ì)
    â”œâ”€â”€ amount (ê¸ˆì•¡)
    â””â”€â”€ final_category (ìµœì¢… ì‚¬ìš©ìš©ë„)
```

#### ì¥ì  âœ…
- **ì˜ë¯¸ë¡ ì  ê²€ìƒ‰**: ë²¡í„° ìœ ì‚¬ë„ë¡œ ì •í™•í•œ ë§¤ì¹­
- **í™•ì¥ì„±**: ìˆ˜ë§Œ ê±´ ì´ìƒ ë°ì´í„° ì²˜ë¦¬ ê°€ëŠ¥
- **íŠ¸ëœì­ì…˜**: ACID ë³´ì¥ìœ¼ë¡œ ë°ì´í„° ì¼ê´€ì„±
- **ë™ì‹œ ì ‘ê·¼**: ë©€í‹° ìœ ì € ì§€ì›

#### ë‹¨ì  âŒ
- **ë³µì¡ë„ ì¦ê°€**: DB ì„¤ì¹˜/ê´€ë¦¬ í•„ìš”
- **ì¸í”„ë¼ ë¹„ìš©**: PostgreSQL ì„œë²„ ìš´ì˜
- **ê°œë°œ ì‹œê°„**: 2~3ì£¼ ì¶”ê°€ ì†Œìš”
- **ì˜¤ë²„ ì—”ì§€ë‹ˆì–´ë§**: í˜„ì¬ ê·œëª¨(100ê±´)ì— ê³¼í•¨

#### êµ¬í˜„ ì˜ˆìƒ
```python
# pgvector ì‚¬ìš© ì˜ˆì‹œ
from sentence_transformers import SentenceTransformer
import psycopg2

model = SentenceTransformer('sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2')

# ê°€ë§¹ì ëª… ì„ë² ë”©
embedding = model.encode("GSì¹¼í…ìŠ¤ ì•ˆì‚°ì ")

# ë²¡í„° ìœ ì‚¬ë„ ê²€ìƒ‰
cursor.execute("""
    SELECT name, category,
           1 - (embedding <=> %s) AS similarity
    FROM merchants
    ORDER BY embedding <=> %s
    LIMIT 5
""", (embedding, embedding))
```

---

### ë°©ì•ˆ B: ê°„ë‹¨í•œ ê°œì„  (íš¨ìœ¨ì ) â­ ì¶”ì²œ

#### í•µì‹¬ ì „ëµ: ë‚´ë¶€ ì²˜ë¦¬ vs ì™¸ë¶€ ì¶œë ¥ ë¶„ë¦¬

```
[ë‚´ë¶€ ì²˜ë¦¬ìš©]
ë¶„ë¥˜_ìƒì„¸.csv
â”œâ”€â”€ ê²°ì œì¼ì
â”œâ”€â”€ ê°€ë§¹ì ëª…
â”œâ”€â”€ ì´ìš©ê¸ˆì•¡
â”œâ”€â”€ ì‚¬ìš©ìš©ë„
â”œâ”€â”€ ì‹ ë¢°ë„ (ë‚´ë¶€ìš©)
â”œâ”€â”€ ë¼ë²¨ì¶œì²˜ (ë‚´ë¶€ìš©)
â””â”€â”€ ê²€í† ì˜ê²¬ (ë‚´ë¶€ìš©)

[ìµœì¢… ì¶œë ¥ìš©] â­
ë²•ì¸ì¹´ë“œ_(ì›”)ì›”_(ì¹´ë“œ).csv
â”œâ”€â”€ ê²°ì œì¼ì
â”œâ”€â”€ ê°€ë§¹ì ëª…
â”œâ”€â”€ ì´ìš©ê¸ˆì•¡
â””â”€â”€ ì‚¬ìš©ìš©ë„
```

#### ì¥ì  âœ…
- **ì¦‰ì‹œ ì ìš© ê°€ëŠ¥**: ì½”ë“œ ìˆ˜ì •ë§Œìœ¼ë¡œ í•´ê²°
- **ë‹¨ìˆœì„± ìœ ì§€**: ê¸°ì¡´ êµ¬ì¡° í™œìš©
- **ë¹„ìš© ì—†ìŒ**: ì¶”ê°€ ì¸í”„ë¼ ë¶ˆí•„ìš”
- **ëª©ì  ë‹¬ì„±**: AI í”ì  ì™„ì „ ì œê±°

#### ë‹¨ì  âŒ
- **ë²¡í„° ê²€ìƒ‰ ë¶€ì¬**: ì˜ë¯¸ì  ìœ ì‚¬ë„ ì œí•œì 
- **í™•ì¥ì„±**: ëŒ€ê·œëª¨(1ë§Œê±´+)ì—ì„œ ì„±ëŠ¥ ì €í•˜

#### êµ¬í˜„ ë°©ë²•
```python
# final_reviewer.py ìˆ˜ì •
def create_clean_output(df):
    """AI í”ì  ì œê±°í•œ ê¹”ë”í•œ ì¶œë ¥"""
    return df[["ê²°ì œì¼ì", "ê°€ë§¹ì ëª…", "ì´ìš©ê¸ˆì•¡", "ì‚¬ìš©ìš©ë„"]]
```

---

### ë°©ì•ˆ C: í•˜ì´ë¸Œë¦¬ë“œ (ì¤‘ê°„)

#### êµ¬ì¡°
```
SQLite + ê°„ë‹¨í•œ ë²¡í„° ê²€ìƒ‰
â”œâ”€â”€ ë¡œì»¬ DB (íŒŒì¼ ê¸°ë°˜)
â”œâ”€â”€ ê°„ë‹¨í•œ ì„ë² ë”© (TF-IDF)
â””â”€â”€ ë¹ ë¥¸ ìœ ì‚¬ë„ ê³„ì‚°
```

#### ì¥ì  âœ…
- **ì„¤ì¹˜ ë¶ˆí•„ìš”**: SQLiteëŠ” Python ë‚´ì¥
- **ì„±ëŠ¥ ê°œì„ **: CSVë³´ë‹¤ ë¹ ë¥¸ ê²€ìƒ‰
- **ë²¡í„° ê²€ìƒ‰**: ê°„ë‹¨í•œ ì„ë² ë”© í™œìš©

#### ë‹¨ì  âŒ
- **ì œí•œì  ë²¡í„° ê¸°ëŠ¥**: pgvectorë§Œí¼ ê°•ë ¥í•˜ì§€ ì•ŠìŒ
- **ë™ì‹œ ì ‘ê·¼ ì œí•œ**: ë©€í‹° ìœ ì € ì–´ë ¤ì›€

---

## 3. ê¶Œì¥ ì†”ë£¨ì…˜

### í˜„ì¬ ê·œëª¨ (100~200ê±´ ì •ë‹µ DB)
â†’ **ë°©ì•ˆ B (ê°„ë‹¨í•œ ê°œì„ )** ì¶”ì²œ

### í–¥í›„ í™•ì¥ (1,000ê±´+ ì •ë‹µ DB)
â†’ **ë°©ì•ˆ C (SQLite)** ê³ ë ¤

### ëŒ€ê·œëª¨ ì—”í„°í”„ë¼ì´ì¦ˆ (10,000ê±´+)
â†’ **ë°©ì•ˆ A (PostgreSQL)** í•„ìš”

---

## 4. ì¦‰ì‹œ ì ìš© ê°€ëŠ¥í•œ ê°œì„ ì•ˆ (ë°©ì•ˆ B)

### 4.1 ì¶œë ¥ í¬ë§· ë¶„ë¦¬

#### ë³€ê²½ ì „
```csv
ê²°ì œì¼ì,ê°€ë§¹ì ëª…,ì´ìš©ê¸ˆì•¡,ì‚¬ìš©ìš©ë„,ì‹ ë¢°ë„,í™•ì •ë°©ë²•,ê²€í† ì˜ê²¬
2025-08-23,ì™€ì™€ì‹ë‹¹,0,ì¤‘ì‹ëŒ€,0.95,ìˆ˜ë™ê²€í† í•„ìš”,"AI ì½”ë©˜íŠ¸"
```

#### ë³€ê²½ í›„
```csv
ê²°ì œì¼ì,ê°€ë§¹ì ëª…,ì´ìš©ê¸ˆì•¡,ì‚¬ìš©ìš©ë„
2025-08-23,ì™€ì™€ì‹ë‹¹,0,ì¤‘ì‹ëŒ€
```

**êµ¬í˜„**:
```python
def create_final_output(...):
    # ë‚´ë¶€ìš© ìƒì„¸ íŒŒì¼
    detailed_df.to_csv("internal/ë¶„ë¥˜_ìƒì„¸_8ì›”_3987.csv")

    # ì™¸ë¶€ìš© ê¹”ë”í•œ íŒŒì¼
    clean_df = detailed_df[["ê²°ì œì¼ì", "ê°€ë§¹ì ëª…", "ì´ìš©ê¸ˆì•¡", "ì‚¬ìš©ìš©ë„"]]
    clean_df.to_csv("ë²•ì¸ì¹´ë“œ_(8)ì›”_3987.csv")
```

### 4.2 ì˜ë¯¸ë¡ ì  ë§¤ì¹­ ê°œì„  (ë²¡í„° ì—†ì´)

#### í˜„ì¬: ë‹¨ìˆœ ë¬¸ìì—´ ë§¤ì¹­
```python
# Fuzzy: í¸ì§‘ê±°ë¦¬ë§Œ
"GSì¹¼í…ìŠ¤" vs "GS ì¹¼í…ìŠ¤" â†’ 0.95

# í•œê³„: ì˜ë¯¸ëŠ” ê°™ì§€ë§Œ í‘œí˜„ì´ ë‹¤ë¥¸ ê²½ìš°
"ì£¼ì‹íšŒì‚¬ ì•„ì„±ë‹¤ì´ì†Œ" vs "ë‹¤ì´ì†Œ" â†’ ë‚®ì€ ì ìˆ˜
```

#### ê°œì„ : í•µì‹¬ í‚¤ì›Œë“œ ì¶”ì¶œ
```python
def extract_keywords(merchant):
    """í•µì‹¬ ë¸Œëœë“œëª… ì¶”ì¶œ"""
    # "ì£¼ì‹íšŒì‚¬ ì•„ì„±ë‹¤ì´ì†Œ" â†’ "ë‹¤ì´ì†Œ"
    # "GSì¹¼í…ìŠ¤(ì£¼)ì¸ì²œê³µí•­ì " â†’ "GSì¹¼í…ìŠ¤"

    brand_patterns = {
        "ë‹¤ì´ì†Œ": r"ë‹¤ì´ì†Œ",
        "GSì¹¼í…ìŠ¤": r"GS.*ì¹¼í…ìŠ¤|ì¹¼í…ìŠ¤",
        "ì¿ íŒ¡": r"ì¿ íŒ¡",
        # ...
    }
```

**íš¨ê³¼**: ë²¡í„° ì—†ì´ë„ 90%+ ë§¤ì¹­ë¥  ë‹¬ì„± ê°€ëŠ¥

### 4.3 Claude API í”„ë¡¬í”„íŠ¸ ìµœì í™”

#### í˜„ì¬ ë¬¸ì œ
```
Few-shot ì˜ˆì‹œ: 5ê°œ (ê³ ì •)
â†’ ì¹´í…Œê³ ë¦¬ ë¶ˆê· í˜•
â†’ ì‹ ê·œ íŒ¨í„´ í•™ìŠµ ë¶€ì¡±
```

#### ê°œì„ 
```python
def smart_example_selection(merchant, master_db):
    """ì§€ëŠ¥í˜• ì˜ˆì‹œ ì„ ì •"""
    # 1. ê°€ë§¹ì ê³¼ ìœ ì‚¬í•œ ì—…ì¢… ìš°ì„ 
    # 2. ì¹´í…Œê³ ë¦¬ë³„ ê· í˜•
    # 3. ìµœì‹  í™•ì • ë¼ë²¨ ìš°ì„ 

    return top_10_examples  # 5ê°œ â†’ 10ê°œë¡œ ì¦ê°€
```

---

## 5. MCP í†µí•© ë°©ì•ˆ

### 5.1 MCP ì„œë²„ ì•„í‚¤í…ì²˜

```python
# card-classifier-mcp-server/server.py
from mcp.server import Server
from mcp.types import Tool

server = Server("card-classifier")

@server.tool()
def classify_card_transactions(
    file_path: str,
    card_number: str
) -> dict:
    """
    ë²•ì¸ì¹´ë“œ ê±°ë˜ ìë™ ë¶„ë¥˜

    Args:
        file_path: ì¹´ë“œ ëª…ì„¸ì„œ ê²½ë¡œ
        card_number: ì¹´ë“œë²ˆí˜¸

    Returns:
        {
            "output_file": "ë²•ì¸ì¹´ë“œ_(8)ì›”_3987.csv",
            "total_count": 42,
            "auto_confirmed": 41,
            "manual_review": 1
        }
    """
    classifier = CardClassifier(...)
    result = classifier.classify_file(file_path)
    return result
```

### 5.2 MCP ë„êµ¬ ì •ì˜

```json
{
  "tools": [
    {
      "name": "classify_transactions",
      "description": "ë²•ì¸ì¹´ë“œ ê±°ë˜ë‚´ì—­ ìë™ ë¶„ë¥˜",
      "inputSchema": {
        "type": "object",
        "properties": {
          "file_path": {"type": "string"},
          "card_number": {"type": "string"}
        }
      }
    },
    {
      "name": "update_master_db",
      "description": "ì •ë‹µ DB ì—…ë°ì´íŠ¸",
      "inputSchema": {
        "type": "object",
        "properties": {
          "merchant": {"type": "string"},
          "category": {"type": "string"}
        }
      }
    }
  ]
}
```

### 5.3 ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤

```bash
# Claude Codeì—ì„œ ì‚¬ìš©
"ì´ë²ˆ ë‹¬ 3987 ì¹´ë“œ ë¶„ë¥˜í•´ì¤˜"

â†’ MCP: classify_transactions(
    file_path="ì¹´ë“œ(3987)8ì›”.xlsx",
    card_number="3987"
  )

â†’ ìë™ ìƒì„±: ë²•ì¸ì¹´ë“œ_(8)ì›”_3987.csv
```

---

## 6. ìµœì¢… ê¶Œì¥ ê°œì„ ì•ˆ

### Phase 1: ì¶œë ¥ í¬ë§· ê°œì„  (ì¦‰ì‹œ ì ìš©) ğŸ”´ ìš°ì„ ìˆœìœ„ ë†’ìŒ

#### ëª©í‘œ
- AI í”ì  ì™„ì „ ì œê±°
- ì‚¬ëŒì´ ì‘ì—…í•œ ê²ƒê³¼ ë™ì¼í•œ ì¶œë ¥

#### êµ¬í˜„
```python
# modules/final_reviewer.py
def create_final_output(...):
    # 1. ë‚´ë¶€ìš© ìƒì„¸ íŒŒì¼ (ê²€í† ìš©)
    internal_df = {
        "ê²°ì œì¼ì", "ê°€ë§¹ì ëª…", "ì´ìš©ê¸ˆì•¡", "ì‚¬ìš©ìš©ë„",
        "ì‹ ë¢°ë„", "ë¼ë²¨ì¶œì²˜", "í™•ì •ë°©ë²•", "ê²€í† ì˜ê²¬"
    }
    internal_df.to_csv("internal/ìƒì„¸_8ì›”_3987.csv")

    # 2. ì™¸ë¶€ìš© ê¹”ë”í•œ íŒŒì¼ (ì œì¶œìš©) â­
    clean_df = df[["ê²°ì œì¼ì", "ê°€ë§¹ì ëª…", "ì´ìš©ê¸ˆì•¡", "ì‚¬ìš©ìš©ë„"]]
    clean_df.to_csv("ë²•ì¸ì¹´ë“œ_(8)ì›”_3987.csv")
```

**ì˜ˆìƒ ì‘ì—…**: 1ì‹œê°„

---

### Phase 2: í‚¤ì›Œë“œ ê¸°ë°˜ ë§¤ì¹­ ê°•í™” (1ì£¼) ğŸŸ¡

#### ëª©í‘œ
- PostgreSQL ì—†ì´ ë§¤ì¹­ë¥  95%+ ë‹¬ì„±

#### êµ¬í˜„
```python
# modules/smart_matcher.py
class SmartMatcher:
    """í‚¤ì›Œë“œ + íŒ¨í„´ ê¸°ë°˜ ì§€ëŠ¥í˜• ë§¤ì¹­"""

    def __init__(self):
        self.brand_keywords = {
            "ë‹¤ì´ì†Œ": ["ë‹¤ì´ì†Œ", "DAISO", "ì•„ì„±ë‹¤ì´ì†Œ"],
            "GSì¹¼í…ìŠ¤": ["GSì¹¼í…ìŠ¤", "GS ì¹¼í…ìŠ¤", "ì¹¼í…ìŠ¤"],
            "ì¿ íŒ¡": ["ì¿ íŒ¡", "coupang"],
            "ë§¥ë„ë‚ ë“œ": ["ë§¥ë„ë‚ ë“œ", "McDonald", "ë§¥ë‚ "],
            # 100+ ë¸Œëœë“œ ì‚¬ì „
        }

    def match(self, merchant):
        # 1. ë¸Œëœë“œ í‚¤ì›Œë“œ ì¶”ì¶œ
        brand = self.extract_brand(merchant)

        # 2. ì •ë‹µ DBì—ì„œ ë™ì¼ ë¸Œëœë“œ ê²€ìƒ‰
        # 3. ì§€ì ëª… ë¬´ì‹œí•˜ê³  ë§¤ì¹­
```

**íš¨ê³¼**:
- "GSì¹¼í…ìŠ¤ ì¸ì²œê³µí•­ì " â†’ "GSì¹¼í…ìŠ¤" ë§¤ì¹­ âœ…
- "ì£¼ì‹íšŒì‚¬ ì•„ì„±ë‹¤ì´ì†Œ" â†’ "ë‹¤ì´ì†Œ" ë§¤ì¹­ âœ…

**ì˜ˆìƒ ì‘ì—…**: 3~5ì¼

---

### Phase 3: MCP ì„œë²„ êµ¬í˜„ (1ì£¼) ğŸŸ¢

#### íŒŒì¼ êµ¬ì¡°
```
card_classifier_mcp/
â”œâ”€â”€ server.py          # MCP ì„œë²„
â”œâ”€â”€ classifier.py      # ê¸°ì¡´ ë¡œì§ ì¬ì‚¬ìš©
â””â”€â”€ config.json        # MCP ì„¤ì •
```

#### êµ¬í˜„
```python
# server.py
@server.tool()
async def classify_card(file_path: str, card: str):
    result = classifier.classify_file(file_path)
    return {"file": f"ë²•ì¸ì¹´ë“œ_{ì›”}ì›”_{card}.csv"}

@server.tool()
async def add_merchant(merchant: str, category: str):
    db.add_entry(merchant, category)
    return {"success": True}
```

**ì˜ˆìƒ ì‘ì—…**: 5~7ì¼

---

## 7. PostgreSQL + pgvector ìƒì„¸ ì„¤ê³„ (ì°¸ê³ ìš©)

### 7.1 ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

```sql
-- ê°€ë§¹ì  ë§ˆìŠ¤í„° í…Œì´ë¸”
CREATE TABLE merchants (
    id SERIAL PRIMARY KEY,
    name VARCHAR(200) UNIQUE NOT NULL,
    normalized_name VARCHAR(200) NOT NULL,
    category VARCHAR(100) NOT NULL,
    embedding vector(384),  -- pgvector
    confidence FLOAT DEFAULT 1.0,
    source VARCHAR(50),  -- 'ìˆ˜ë™', 'AI', 'í”¼ë“œë°±'
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- ë²¡í„° ì¸ë±ìŠ¤ ìƒì„±
CREATE INDEX ON merchants
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);

-- ê±°ë˜ ë‚´ì—­ í…Œì´ë¸”
CREATE TABLE transactions (
    id SERIAL PRIMARY KEY,
    card_number VARCHAR(20),
    merchant_name VARCHAR(200),
    payment_date DATE,
    amount INTEGER,
    matched_merchant_id INTEGER REFERENCES merchants(id),
    final_category VARCHAR(100),
    confidence FLOAT,
    label_source VARCHAR(50),
    reviewed BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW()
);

-- í”¼ë“œë°± ë¡œê·¸ í…Œì´ë¸”
CREATE TABLE feedback_log (
    id SERIAL PRIMARY KEY,
    merchant_name VARCHAR(200),
    predicted_category VARCHAR(100),
    confirmed_category VARCHAR(100),
    confidence FLOAT,
    reviewed_by VARCHAR(100),
    reviewed_at TIMESTAMP DEFAULT NOW()
);
```

### 7.2 ë²¡í„° ì„ë² ë”© ìƒì„±

```python
from sentence_transformers import SentenceTransformer

# í•œêµ­ì–´ íŠ¹í™” ëª¨ë¸
model = SentenceTransformer('jhgan/ko-sroberta-multitask')

def create_embedding(merchant_name):
    """ê°€ë§¹ì ëª… ë²¡í„° ì„ë² ë”©"""
    return model.encode(merchant_name).tolist()

# DBì— ì €ì¥
embedding = create_embedding("GSì¹¼í…ìŠ¤ ì•ˆì‚°ì ")
cursor.execute(
    "INSERT INTO merchants (name, normalized_name, category, embedding) "
    "VALUES (%s, %s, %s, %s)",
    ("GSì¹¼í…ìŠ¤ ì•ˆì‚°ì ", "GSì¹¼í…ìŠ¤", "ì°¨ëŸ‰ìœ ì§€ë¹„(ì£¼ìœ )", embedding)
)
```

### 7.3 ë²¡í„° ìœ ì‚¬ë„ ê²€ìƒ‰

```python
def vector_search(merchant_name, threshold=0.8):
    """ë²¡í„° ìœ ì‚¬ë„ ê¸°ë°˜ ê²€ìƒ‰"""
    embedding = create_embedding(merchant_name)

    cursor.execute("""
        SELECT
            name,
            category,
            1 - (embedding <=> %s::vector) AS similarity
        FROM merchants
        WHERE 1 - (embedding <=> %s::vector) > %s
        ORDER BY embedding <=> %s::vector
        LIMIT 5
    """, (embedding, embedding, threshold, embedding))

    return cursor.fetchall()
```

### 7.4 ë¹„ìš© ë¶„ì„

```
PostgreSQL í˜¸ìŠ¤íŒ…:
- AWS RDS: $15~30/ì›”
- Heroku: $5~10/ì›”
- ìì²´ í˜¸ìŠ¤íŒ…: ì„œë²„ ë¹„ìš©

pgvector ëª¨ë¸:
- ko-sroberta: ë¡œì»¬ ì‹¤í–‰ (ë¬´ë£Œ)
- ë©”ëª¨ë¦¬: ~500MB

ì´ ìš´ì˜ ë¹„ìš©: $5~30/ì›”
```

---

## 8. ìµœì¢… ê¶Œì¥ ë¡œë“œë§µ

### ì¦‰ì‹œ ì‹¤í–‰ (ì˜¤ëŠ˜) ğŸ”´
```
âœ… Git í‘¸ì‹œ ì™„ë£Œ
â†’ Phase 1: ì¶œë ¥ í¬ë§· ê°œì„ 
   - ê¹”ë”í•œ 4ì»¬ëŸ¼ ì¶œë ¥ êµ¬í˜„
   - ë‚´ë¶€/ì™¸ë¶€ íŒŒì¼ ë¶„ë¦¬
   - ì†Œìš” ì‹œê°„: 1ì‹œê°„
```

### 1ì£¼ì°¨ ğŸŸ¡
```
â†’ Phase 2: í‚¤ì›Œë“œ ë§¤ì¹­ ê°•í™”
   - ë¸Œëœë“œ í‚¤ì›Œë“œ ì‚¬ì „ (100ê°œ)
   - ì§€ì ëª… ì œê±° ë¡œì§ ê³ ë„í™”
   - ë§¤ì¹­ë¥  95%+ ëª©í‘œ
   - ì†Œìš” ì‹œê°„: 3ì¼
```

### 2ì£¼ì°¨ ğŸŸ¢
```
â†’ Phase 3: MCP ì„œë²„ êµ¬í˜„
   - ê¸°ë³¸ MCP ë„êµ¬ 2ê°œ
   - Claude Code í†µí•©
   - ì›Œí¬í”Œë¡œìš° ìë™í™”
   - ì†Œìš” ì‹œê°„: 5ì¼
```

### í–¥í›„ ê²€í†  (3ê°œì›” í›„)
```
â†’ PostgreSQL ì „í™˜ ê²€í† 
   - ì •ë‹µ DB ê·œëª¨ í™•ì¸ (1,000ê±´ ì´ìƒ ì‹œ)
   - ì„±ëŠ¥ ì´ìŠˆ ë°œìƒ ì‹œ
   - ë²¡í„° ê²€ìƒ‰ í•„ìš”ì„± í‰ê°€
```

---

## 9. êµ¬ì²´ì  êµ¬í˜„ ê³„íš

### 9.1 ê¹”ë”í•œ ì¶œë ¥ (Phase 1)

```python
# modules/final_reviewer.py ìˆ˜ì •

def create_final_output(self, reviewed_df, output_path, card_number):
    # ê²°ì œì›” ì¶”ì¶œ
    month = self._extract_month(reviewed_df)

    # ê²½ë¡œ ì„¤ì •
    if output_path is None:
        base_dir = Path("output")

        # ë‚´ë¶€ìš© ìƒì„¸ íŒŒì¼
        internal_path = base_dir / "internal" / f"ìƒì„¸_{month}ì›”_{card_number}.csv"

        # ì™¸ë¶€ìš© ê¹”ë”í•œ íŒŒì¼
        external_path = base_dir / f"ë²•ì¸ì¹´ë“œ_({month})ì›”_{card_number}.csv"

    # 1. ë‚´ë¶€ìš©: ì „ì²´ ì •ë³´ (ê²€í† ìš©)
    internal_df = reviewed_df[[
        "ê²°ì œì¼ì", "ê°€ë§¹ì ëª…", "ì´ìš©ê¸ˆì•¡", "ì‚¬ìš©ìš©ë„",
        "ì‹ ë¢°ë„", "í™•ì •ë°©ë²•", "ê²€í† ì˜ê²¬", "ë¼ë²¨ì¶œì²˜"
    ]]
    internal_df.to_csv(internal_path)

    # 2. ì™¸ë¶€ìš©: ê¹”ë”í•œ 4ì»¬ëŸ¼ë§Œ (ì œì¶œìš©) â­
    clean_df = reviewed_df[["ê²°ì œì¼ì", "ê°€ë§¹ì ëª…", "ì´ìš©ê¸ˆì•¡", "ì‚¬ìš©ìš©ë„"]]
    clean_df.to_csv(external_path)
    clean_df.to_excel(external_path.with_suffix('.xlsx'))

    print(f"âœ… ì œì¶œìš© íŒŒì¼: {external_path}")
    print(f"ğŸ“Š ë‚´ë¶€ ê²€í† ìš©: {internal_path}")
```

### 9.2 ë¸Œëœë“œ í‚¤ì›Œë“œ ì‚¬ì „ (Phase 2)

```python
# config.pyì— ì¶”ê°€
BRAND_KEYWORDS = {
    # ì£¼ìœ ì†Œ
    "GSì¹¼í…ìŠ¤": ["GSì¹¼í…ìŠ¤", "GS ì¹¼í…ìŠ¤", "ì¹¼í…ìŠ¤", "GScaltex"],
    "SKì—ë„ˆì§€": ["SKì—ë„ˆì§€", "SK ì—ë„ˆì§€", "SKì£¼ìœ ì†Œ"],
    "S-OIL": ["S-OIL", "ì—ìŠ¤ì˜¤ì¼", "SOIL"],

    # ìŒì‹ì  ì²´ì¸
    "ë§¥ë„ë‚ ë“œ": ["ë§¥ë„ë‚ ë“œ", "McDonald", "ë§¥ë‚ "],
    "ë¡¯ë°ë¦¬ì•„": ["ë¡¯ë°ë¦¬ì•„", "Lotteria"],
    "ì„œë¸Œì›¨ì´": ["ì¨ë¸Œì›¨ì´", "ì„œë¸Œì›¨ì´", "Subway"],

    # ì‡¼í•‘
    "ì¿ íŒ¡": ["ì¿ íŒ¡", "coupang"],
    "ë‹¤ì´ì†Œ": ["ë‹¤ì´ì†Œ", "DAISO", "ì•„ì„±ë‹¤ì´ì†Œ"],

    # 100+ ë¸Œëœë“œ...
}

# modules/smart_matcher.py
class BrandMatcher:
    def match(self, merchant):
        for brand, keywords in BRAND_KEYWORDS.items():
            if any(kw in merchant for kw in keywords):
                return self.lookup_brand(brand)
        return None
```

### 9.3 MCP ì„œë²„ êµ¬í˜„ (Phase 3)

```python
# mcp_server/server.py
from mcp.server import Server
from pathlib import Path
import sys
sys.path.append('../card_classifier')
from modules.classifier import CardClassifier

server = Server("card-classifier")

@server.tool()
async def classify_card_transactions(
    file_path: str,
    card_number: str = "3987",
    enable_claude: bool = True
) -> dict:
    """ë²•ì¸ì¹´ë“œ ê±°ë˜ ìë™ ë¶„ë¥˜"""
    classifier = CardClassifier(
        master_db_path=Path("../data/master_db.csv"),
        enable_claude=enable_claude
    )

    result = classifier.classify_file(file_path)

    # ìµœì¢… ê²€í† 
    reviewer = FinalReviewer()
    final = reviewer.create_final_output(result, card_number=card_number)

    return {
        "output_file": f"ë²•ì¸ì¹´ë“œ_(ì›”)ì›”_{card_number}.csv",
        "total_transactions": len(final),
        "auto_confirmed": len(final[final['í™•ì •ë°©ë²•']=='ìë™í™•ì •']),
        "needs_review": len(final[final['í™•ì •ë°©ë²•']=='ìˆ˜ë™ê²€í† í•„ìš”'])
    }

@server.tool()
async def add_merchant_mapping(
    merchant: str,
    category: str
) -> dict:
    """ì •ë‹µ DBì— ê°€ë§¹ì  ì¶”ê°€"""
    # í”¼ë“œë°± ê¸°ëŠ¥ í™œìš©
    manager = FeedbackManager(...)
    result = manager.add_entry(merchant, category)
    return result

if __name__ == "__main__":
    server.run()
```

---

## 10. ë¹„êµ ë§¤íŠ¸ë¦­ìŠ¤

| ê¸°ì¤€ | í˜„ì¬(CSV) | ë°©ì•ˆB(ê°œì„ ) | ë°©ì•ˆC(SQLite) | ë°©ì•ˆA(PostgreSQL) |
|------|----------|------------|--------------|------------------|
| **êµ¬í˜„ ë‚œì´ë„** | - | â­â­â­â­â­ ì‰¬ì›€ | â­â­â­â­ ë³´í†µ | â­â­ ì–´ë ¤ì›€ |
| **ê°œë°œ ì‹œê°„** | - | 1ì‹œê°„ | 3ì¼ | 2ì£¼ |
| **AI í”ì  ì œê±°** | âŒ | âœ… | âœ… | âœ… |
| **ë§¤ì¹­ ì •í™•ë„** | 89% | 95% | 97% | 99% |
| **í™•ì¥ì„±** | ~1K | ~5K | ~50K | ë¬´ì œí•œ |
| **ìš´ì˜ ë¹„ìš©** | $0 | $0 | $0 | $5~30/ì›” |
| **ë²¡í„° ê²€ìƒ‰** | âŒ | âŒ | â–³ (TF-IDF) | âœ… (pgvector) |
| **MCP í†µí•©** | âŒ | âœ… | âœ… | âœ… |
| **í˜„ì¬ ê·œëª¨ ì í•©ì„±** | â–³ | âœ… | âœ… | âŒ ê³¼í•¨ |

---

## 11. ìµœì¢… ê¶Œì¥ì‚¬í•­

### ì¦‰ì‹œ ì‹¤í–‰ (ì˜¤ëŠ˜)
```
1. ì¶œë ¥ í¬ë§· ê°œì„  (Phase 1)
   - AI í”ì  ì œê±°
   - 4ì»¬ëŸ¼ ê¹”ë”í•œ ì¶œë ¥
   - ì†Œìš”: 1ì‹œê°„
```

### 1ì£¼ ë‚´
```
2. í‚¤ì›Œë“œ ë§¤ì¹­ ê°•í™” (Phase 2)
   - ë¸Œëœë“œ í‚¤ì›Œë“œ ì‚¬ì „ 100ê°œ
   - ë§¤ì¹­ë¥  95% ë‹¬ì„±
   - ì†Œìš”: 3ì¼

3. MCP ì„œë²„ êµ¬í˜„ (Phase 3)
   - ê¸°ë³¸ ë„êµ¬ 2ê°œ
   - Claude Code í†µí•©
   - ì†Œìš”: 5ì¼
```

### í–¥í›„ ê²€í†  (í•„ìš” ì‹œ)
```
4. PostgreSQL ì „í™˜
   - ì •ë‹µ DB > 1,000ê±´ ì‹œ
   - ë²¡í„° ê²€ìƒ‰ í•„ìš” ì‹œ
   - ì˜ˆì‚° í™•ë³´ í›„
```

---

## 12. ì¦‰ì‹œ ì ìš© ì½”ë“œ (Phase 1)

### ìˆ˜ì •í•  íŒŒì¼
```python
# modules/final_reviewer.py

def create_final_output(self, reviewed_df, output_path=None, card_number="3987"):
    month = self._extract_month(reviewed_df)

    if output_path is None:
        base_dir = Path("output")
        internal_dir = base_dir / "internal"
        internal_dir.mkdir(exist_ok=True)

        # ë‚´ë¶€ìš© (ê²€í† ìš©)
        internal_path = internal_dir / f"ìƒì„¸_{month}ì›”_{card_number}.csv"

        # ì™¸ë¶€ìš© (ì œì¶œìš©)
        external_path = base_dir / f"ë²•ì¸ì¹´ë“œ_({month})ì›”_{card_number}.csv"

    # ë‚´ë¶€ìš©: ì „ì²´ ì»¬ëŸ¼
    internal_df = reviewed_df[[
        "ê²°ì œì¼ì", "ê°€ë§¹ì ëª…_ì›ë³¸", "ê°€ë§¹ì ëª…", "ì´ìš©ê¸ˆì•¡",
        "ì‚¬ìš©ìš©ë„", "ì‹ ë¢°ë„", "í™•ì •ë°©ë²•", "ë¼ë²¨ì¶œì²˜"
    ]]
    if "ê²€í† ì˜ê²¬" in reviewed_df.columns:
        internal_df["ê²€í† ì˜ê²¬"] = reviewed_df["ê²€í† ì˜ê²¬"]

    internal_df.to_csv(internal_path, index=False, encoding="utf-8-sig")

    # ì™¸ë¶€ìš©: ê¹”ë”í•œ 4ì»¬ëŸ¼ë§Œ â­
    clean_df = pd.DataFrame({
        "ê²°ì œì¼ì": reviewed_df["ê²°ì œì¼ì"],
        "ê°€ë§¹ì ëª…": reviewed_df["ê°€ë§¹ì ëª…_ì›ë³¸"],
        "ì´ìš©ê¸ˆì•¡": reviewed_df["ì´ìš©ê¸ˆì•¡"],
        "ì‚¬ìš©ìš©ë„": reviewed_df["ìµœì¢…ì‚¬ìš©ìš©ë„"]
    })

    # ê²°ì¸¡ê°’ ì œê±°
    clean_df = clean_df[clean_df["ê°€ë§¹ì ëª…"].notna()].copy()

    # ì €ì¥
    clean_df.to_csv(external_path, index=False, encoding="utf-8-sig")
    clean_df.to_excel(external_path.with_suffix('.xlsx'), index=False)

    print(f"\nâœ… ì œì¶œìš© íŒŒì¼: {external_path}")
    print(f"   (AI í”ì  ì—†ëŠ” ê¹”ë”í•œ 4ì»¬ëŸ¼)")
    print(f"ğŸ“Š ë‚´ë¶€ ê²€í† ìš©: {internal_path}")
    print(f"   (ìƒì„¸ ì •ë³´ í¬í•¨)")
```

---

## 13. ê²°ë¡  ë° ì œì•ˆ

### ì¦‰ì‹œ ì ìš© (ì˜¤ëŠ˜ 1ì‹œê°„)
```
âœ… ì¶œë ¥ í¬ë§· ê°œì„  (ë°©ì•ˆ Bì˜ Phase 1)
   â†’ AI í”ì  ì™„ì „ ì œê±°
   â†’ ëª©ì  100% ë‹¬ì„±
```

### PostgreSQLì€ ë³´ë¥˜
```
ì´ìœ :
1. í˜„ì¬ ê·œëª¨(104ê±´)ì— ê³¼í•œ ì†”ë£¨ì…˜
2. ë‹¨ìˆœ ê°œì„ ìœ¼ë¡œ ëª©ì  ë‹¬ì„± ê°€ëŠ¥
3. ìš´ì˜ ë³µì¡ë„/ë¹„ìš© ì¦ê°€
4. ê°œë°œ ì‹œê°„ 2ì£¼+ ì†Œìš”

ì¬ê²€í†  ì‹œì :
- ì •ë‹µ DB > 1,000ê±´
- ì„±ëŠ¥ ì´ìŠˆ ë°œìƒ ì‹œ
- ë©€í‹° ìœ ì € í™˜ê²½ í•„ìš” ì‹œ
```

### MCP í†µí•© (ë‹¤ìŒ ì£¼)
```
âœ… ê°„ë‹¨í•œ MCP ì„œë²„ êµ¬í˜„
   â†’ Claude Codeì—ì„œ ì§ì ‘ í˜¸ì¶œ
   â†’ ì›Œí¬í”Œë¡œìš° ìë™í™”
```

**ì§€ê¸ˆ ë°”ë¡œ Phase 1 (ì¶œë ¥ í¬ë§· ê°œì„ )ì„ ì ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?**