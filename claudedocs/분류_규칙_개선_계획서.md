# 법인카드 분류 규칙 개선 계획서

작성일: 2025-10-22
버전: 3.0

---

## 1. 현황 분석

### 1.1 발견된 오분류 항목

#### 4985 카드 (50건)
```
현재: 복리후생/중식대/기타
요구: 거래처 교제비

예시:
- 밥주까회주까 (130,000원) → 중식대 → 거래처 교제비
- 화랑갈비시흥점 (35,000원) → 중식대 → 거래처 교제비
- 팡파르 (400,000원) → 기타 → 거래처 교제비
```

#### 6974 카드
```
1. 쿠팡 관련 (8건)
   현재: 회사물품구입비/보험료
   요구: 기숙사 물품 구입비

2. SKT 자동납부 (6건)
   - SKT-자동납부-647179 (3건) → 휴대폰(010-7504-4043)사용료
   - SKT-자동납부-044043 (3건) → 휴대폰(010-3664-7179)사용료

3. 홈플러스/트레이더스 (6건)
   현재: 소모품비/차량유지비(부품)/기타/복리후생비
   요구: 기숙사 물품 구입비
   특이: 상품권 거래 포함 (1,000만원)
```

---

## 2. 문제 분석

### 2.1 카드별 용도 차이
```
일반 법인카드 (3987, 9980 등):
- 중식대 = 직원 식대
- 쿠팡 = 회사물품구입비

특수 카드 (4985, 6974):
- 중식대 → 거래처 교제비 (외부 접대)
- 쿠팡 → 기숙사 물품 구입비 (특정 목적)
```

### 2.2 카드별 규칙 필요성
```
문제: 동일 가맹점명이 카드별로 다른 용도
해결: 카드별 규칙 적용 로직
```

---

## 3. 개선 방안

### 방안 A: 카드별 규칙 엔진 (추천) ⭐

#### 구조
```python
# config.py
CARD_SPECIFIC_RULES = {
    "4985": {
        "중식대": "거래처 교제비",
        "복리후생": "거래처 교제비",
        "기타": "거래처 교제비"
    },
    "6974": {
        "keywords": {
            "쿠팡": "기숙사 물품 구입비",
            "홈플러스": "기숙사 물품 구입비",
            "트레이더스": "기숙사 물품 구입비"
        },
        "exact_match": {
            "SKT-자동납부-647179": "휴대폰(010-7504-4043)사용료",
            "SKT-자동납부-044043": "휴대폰(010-3664-7179)사용료"
        }
    }
}
```

#### 장점
- ✅ 카드별 맞춤 규칙
- ✅ 유지보수 용이
- ✅ 확장 가능

---

### 방안 B: Master DB에 카드번호 컬럼 추가

#### 구조
```csv
가맹점명,사용용도,카드번호
쿠팡,회사물품구입비,3987
쿠팡,기숙사 물품 구입비,6974
```

#### 단점
- ❌ DB 구조 변경 필요
- ❌ 기존 로직 대폭 수정
- ❌ 복잡도 증가

---

## 4. 최종 권장안 (방안 A)

### 4.1 카드별 후처리 규칙

```python
# modules/card_rules.py (신규)
class CardSpecificRules:
    """카드별 특수 규칙"""

    CARD_RULES = {
        "4985": {
            "category_mapping": {
                "중식대": "거래처 교제비",
                "복리후생": "거래처 교제비",
                "복리후생비": "거래처 교제비",
                "기타": "거래처 교제비"
            }
        },
        "6974": {
            "keyword_rules": {
                "쿠팡": "기숙사 물품 구입비",
                "홈플러스": "기숙사 물품 구입비",
                "트레이더스": "기숙사 물품 구입비"
            },
            "exact_match": {
                "SKT-자동납부-647179": "휴대폰(010-7504-4043)사용료",
                "SKT-자동납부-044043": "휴대폰(010-3664-7179)사용료"
            }
        }
    }

    def apply(self, card_number, merchant, category):
        """카드별 규칙 적용"""
        if card_number not in self.CARD_RULES:
            return category

        rules = self.CARD_RULES[card_number]

        # 1. 정확 일치 규칙
        if "exact_match" in rules:
            if merchant in rules["exact_match"]:
                return rules["exact_match"][merchant]

        # 2. 키워드 규칙
        if "keyword_rules" in rules:
            for keyword, new_category in rules["keyword_rules"].items():
                if keyword in merchant:
                    return new_category

        # 3. 카테고리 매핑 규칙
        if "category_mapping" in rules:
            if category in rules["category_mapping"]:
                return rules["category_mapping"][category]

        return category
```

### 4.2 통합 지점

```python
# modules/classifier.py (수정)
def classify_single(self, merchant, context, card_number=None):
    # 기존 분류 로직...
    result = self.matcher.match(normalized)

    # 카드별 규칙 적용 (신규)
    if card_number:
        from .card_rules import CardSpecificRules
        card_rules = CardSpecificRules()
        result["사용용도"] = card_rules.apply(
            card_number,
            merchant,
            result["사용용도"]
        )

    return result
```

---

## 5. 구현 계획

### Phase 1: 카드별 규칙 모듈 생성
```
1. modules/card_rules.py 작성
2. 4985, 6974 규칙 정의
3. 단위 테스트
```

### Phase 2: 기존 시스템 통합
```
1. classifier.py에 card_number 파라미터 전달
2. 카드별 규칙 적용 로직 추가
3. consolidate_to_main_sheet.py 수정
```

### Phase 3: Master DB 업데이트
```
1. 각 규칙을 master_db.csv에 반영
2. 중복 방지 로직
3. 백업 생성
```

### Phase 4: 메인 시트 재처리
```
1. 기존 메인 시트 백업
2. 전체 재처리 실행
3. 결과 검증
```

---

## 6. Master DB 업데이트 항목

### 추가 필요 항목
```csv
# 6974 카드 전용
쿠팡,기숙사 물품 구입비
쿠팡-쿠팡(주),기숙사 물품 구입비
쿠팡(주)-쿠팡(주),기숙사 물품 구입비
홈플러스,기숙사 물품 구입비
홈플러스(주)시화점,기숙사 물품 구입비
트레이더스,기숙사 물품 구입비
트레이더스 안산점,기숙사 물품 구입비
트레이더스 홀세일클럽 안산점,기숙사 물품 구입비
SKT-자동납부-647179,휴대폰(010-7504-4043)사용료
SKT-자동납부-044043,휴대폰(010-3664-7179)사용료

# 주의: 이것들은 6974 카드에만 적용되어야 함
# 다른 카드의 쿠팡은 "회사물품구입비" 유지
```

---

## 7. 즉시 적용 방법 (간단)

### 현재 메인 시트만 수정
```python
# 빠른 수정 스크립트
import openpyxl

wb = openpyxl.load_workbook('칠칠기업_법인카드_완성본.xlsx')

# 4985 시트
sheet_4985 = wb['4985']
for row in sheet_4985.iter_rows(min_row=2):
    category = row[3].value
    if category in ['복리후생', '중식대', '기타', '복리후생비']:
        row[3].value = '거래처 교제비'

# 6974 시트
sheet_6974 = wb['6974']
for row in sheet_6974.iter_rows(min_row=2):
    merchant = row[1].value
    category = row[3].value

    if '쿠팡' in str(merchant):
        row[3].value = '기숙사 물품 구입비'
    elif merchant == 'SKT-자동납부-647179':
        row[3].value = '휴대폰(010-7504-4043)사용료'
    elif merchant == 'SKT-자동납부-044043':
        row[3].value = '휴대폰(010-3664-7179)사용료'
    elif '홈플러스' in str(merchant) or '트레이더스' in str(merchant):
        row[3].value = '기숙사 물품 구입비'

wb.save('칠칠기업_법인카드_완성본.xlsx')
```

---

## 8. 권장 실행 순서

### 즉시 (30분)
```
1. 메인 시트 직접 수정 스크립트 실행
2. master_db.csv 업데이트
3. 결과 검증
4. Git 커밋
```

### 향후 (필요 시)
```
1. card_rules.py 모듈 구현
2. 시스템 통합
3. 자동화
```

---

## 9. 예상 수정 건수

```
4985 카드: 50건 수정
6974 카드: 23건 수정
  - 쿠팡: 8건
  - SKT: 6건
  - 홈플러스/트레이더스: 6건 (상품권 포함)
  - 기타 겹치는 항목: 3건

총 예상: 73건 수정
```

---

## 10. 리스크 및 주의사항

### 주의: 트레이더스 상품권
```
트레이더스 홀세일클럽 안산점(상품권): 1,000만원
현재: 기타/복리후생비
요구: 기숙사 물품 구입비?

→ 확인 필요: 상품권도 기숙사 물품인지?
```

### 주의: 4985 카드 전체 변경
```
모든 중식대 → 거래처 교제비
영향: 대부분의 거래

확인 필요: 정말 모든 식대가 교제비인지?
```
